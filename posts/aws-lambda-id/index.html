<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="shortcut icon" href="http://dhanangw.github.io/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.min.css">

    <title>Cara Deploy Python 3 di AWS Lambda</title>
</head>
<body><header id="banner">
    <h2><a href="http://dhanangw.github.io/">dhanangw writings</a></h2>
    <nav>
        <ul>
            
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>Cara Deploy Python 3 di AWS Lambda</h1>
            <div>
                <time>October 24, 2021</time>
                </div>
    </header><blockquote>
<p>Copied from Medium with slight correction</p>
</blockquote>
<p>September 2018 lalu, saya mendapat kesempatan magang di kumparan sebagai Data Engineer. Sebagai tugas magang, saya ditugaskan membuat <em>distributed web scraper</em> untuk mengumpulkan data perhitungan Pemilu 2014 serta gambar scan C1 tiap TPS dari situs kawalpemilu.org.</p>
<p>Kami memutuskan untuk menggunakan Amazon Web Services (AWS). <em>Worker</em> dari <em>distributed web scraper</em> nya dijalankan di AWS Lambda karena Lambda memungkinkan kami tidak repot di <em>maintenance</em>, dan dapat mendukung <em>concurrency</em> secara otomatis. Serta kami menggunakan AWS SQS untuk mengatur workernya.</p>
<p>Sebagai pengingat, berikut panduan sederhana menjalankan sebuah program Python3 di AWS Lambda dalam Bahasa Indonesia. Beberapa hal dalam panduan ini dapat dilakukan menggunakan AWS CLI, namun demi kesederhanaan kita akan menggunakan AWS Console.</p>
<h1 id="peringatan">Peringatan</h1>
<p>Cara ini terakhir dicoba pada <em>Desember 2018</em> lalu. Saat ini mungkin sudah terjadi perubahan cara deployment AWS Lambda.</p>
<h1 id="persyaratan">Persyaratan</h1>
<p>Dalam panduan ini saya berasumsi bahwa:</p>
<ol>
<li><em>Code</em> anda sudah menerapkan Function Handler.</li>
<li><em>Code</em> anda sudah tercatat Git.</li>
<li>Anda memiliki akun AWS Console yang memiliki hak untuk membuat Lambda Function dan mengupload object ke S3.</li>
<li>AWS CLI terinstall dan ter-<em>setup</em> di komputer anda (ini opsional, hal-hal yang menggunakan AWS CLI dapat dilakukan melalui AWS Console).</li>
<li>Docker sudah terinstall di komputer anda.</li>
</ol>
<h1 id="bagian-i-menyiapkan-modul-modul">Bagian I: menyiapkan modul-modul</h1>
<p>Pastikan semua modul yang digunakan project anda tercatat dalam sebuah <code>requirements.txt</code>. Apabila belum, buatlah <code>requirements.txt</code> dengan menjalankan command berikut dalam terminal:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip3 freeze &gt; requirements.txt
</code></pre></div><p>pip akan mencatat semua nama dan versi package yang terinstall ke dalam sebuah file .txt (dalam panduan ini kita menggunakan pip3).</p>
<p>Push file <code>requirements.txt</code> ke Git repository project anda:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git add requirements.txt
git commit -m <span style="color:#e6db74">&#34;add requirements.txt&#34;</span>
git push
</code></pre></div><p>Gunakan Docker untuk menjalankan image <code>dacut/amazon-linux-python-3.6</code>, AWS Lambda hanya dapat menggunakan modul yang diinstal menggunakan distribusi Linux tersebut:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -it dacut/amazon-linux-python-3.6
</code></pre></div><p>Pastikan anda sudah berada di environment docker container dengan menjalankan command <code>uname</code>. Outputnya akan seperti berikut:</p>
<blockquote>
<p><img src="/aws-lambda-id/1.png#content" alt="Environment docker container"></p>
</blockquote>
<p>Pada terminal docker container anda, install Git, lalu clone repository project anda:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Install Git</span>
yum install git

<span style="color:#75715e"># Clone repository project anda</span>
git clone &lt;url-repository&gt;

<span style="color:#75715e"># masuk ke directory project anda</span>
cd &lt;nama-project&gt;
</code></pre></div><p>Install package <code>virtualenv</code> menggunakan pip. virtualenv akan menampung semua modul yang akan dicompile ke dalam sebuah virtual environment.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip3 install virtualenv
</code></pre></div><p>Setelah instalasi selesai, buat dan aktifkan sebuah virtual environment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># buat sebuah virtual environment dengan nama &#39;env&#39;</span>
virtualenv env

<span style="color:#75715e"># aktifkan virtual environment</span>
. env/bin/activate
</code></pre></div><p>Setelah virtual environment anda aktif, install semua package yang terdaftar di requirements.txt:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip3 install -r requirements.txt
</code></pre></div><p>Setelah proses instalasi selesai, kita akan copy semua modul yang terinstall di environment docker container ke environment komputer kita yang sebenarnya. sebelumnya kita perlu tahu <code>container_id</code> yang menjalankan image amazon-linux-python-3.6. Buka session terminal baru dan masukkan command berikut</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker container ls
</code></pre></div><p>Output command tersebut adalah sebagai berikut:</p>
<blockquote>
<p><img src="/aws-lambda-id/2.png#content" alt="Output &lsquo;docker container ls&rsquo;"></p>
</blockquote>
<p>Copy container ID-nya, dan masukkan command berikut untuk meng-copy semua package yang di compile pada docker container ke environment komputer local kita. Package yang telah di compile berada pada directory <em><!-- raw HTML omitted -->/env/lib/python3.6/site-packages</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker cp &lt;CONTAINER_ID&gt;:&lt;nama-git-repo&gt;/env/lib/python3.6/site-packages &lt;LOCAL_PATH&gt;
</code></pre></div><p>contoh:</p>
<blockquote>
<p><img src="/aws-lambda-id/3.png#content" alt="Contoh docker cp"></p>
</blockquote>
<h1 id="bagian-ii-deploy-ke-aws-lambda">Bagian II: Deploy ke AWS Lambda</h1>
<p>Buat sebuah folder baru, masukkan semua .py files dan modul-modul anda ke folder tersebut. lalu masuklah ke folder tersebut dan zip semua file yang ada di dalamnya</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># buat sebuah folder baru</span>
mkdir AWSLambdaPython3Tutorial

<span style="color:#75715e"># masukkan semua modul-modul yang diinstall di docker container</span>
cp -R site-packages/ AWSLambdaPython3Tutorial/

<span style="color:#75715e"># masukkan semua .py files anda</span>
cp -R &lt;path-to-.py-files&gt; AWSLambdaPython3Tutorial/

<span style="color:#75715e"># masuk ke folder</span>
cd AWSLambdaPython3Tutorial

<span style="color:#75715e"># zip semua file yang ada di folder tersebut</span>
zip -r AWSLambdaPython3Tutorial.zip .
</code></pre></div><p>Upload zip file tersebut ke S3. Anda dapat menggunakan AWS CLI atau upload melalui AWS Console.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws s3 cp &lt;path-to-.zip-file&gt; s3://&lt;bucket-S3-anda&gt; --profile dhanangw-aws-es --profile &lt;profile-aws-cli-name&gt;
</code></pre></div><blockquote>
<p><img src="/aws-lambda-id/4.png#content" alt="Upload melalui AWS Lambda Console"></p>
</blockquote>
<p>kemudian copy S3 URL file .zip. Anda dapat temukan URL nya pada output dari command <em>aws s3 cp</em> atau anda dapat melihatnya AWS S3 Console.<br>
<img src="/aws-lambda-id/5.png#content" alt="Output &lsquo;aws s3 cp&rsquo;"></p>
<blockquote>
<p><img src="/aws-lambda-id/6.png#content" alt="S3 URL di AWS S3 Console"></p>
</blockquote>
<p>Pada bagian “Function Code”, pilih “Upload a file from Amazon S3” pada drop-down “Code entry type”. paste copy URL S3 file .zip anda. Jangan lupa untuk mengubah pilihan “Runtime” menjadi Python</p>
<blockquote>
<p><img src="/aws-lambda-id/7.png#content" alt="Copy-paste di field-field berikut"></p>
</blockquote>
<h1 id="references">References</h1>
<ol>
<li><a href="https://medium.com/i-like-big-data-and-i-cannot-lie/how-to-create-an-aws-lambda-python-3-6-deployment-package-using-docker-d0e847207dd6">Peter Begle&rsquo;s guide</a></li>
<li><a href="https://joarleymoraes.com/hassle-free-python-lambda-deployment/">Joarley Moraes&rsquo; guide</a></li>
</ol>
</article>

        </main><footer id="footer">
    
</footer>
</body>
</html>
