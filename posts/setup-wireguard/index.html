<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=http://dhanangw.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Setup WireGuard VPN in Google Cloud Platform</title></head><body><header id=banner><h2><a href=http://dhanangw.github.io/>dhanangw writings</a></h2><nav><ul></ul></nav></header><main id=content><article><header id=post-header><h1>Setup WireGuard VPN in Google Cloud Platform</h1><div><time>September 11, 2021</time></div></header><blockquote><p>Copied from Medium with slight correction</p></blockquote><p>WireGuard VPN running on Google Compute Engine (GCE) Virtual Machine (VM) with Ubuntu 20.04 LTS. We’re going to put our WireGuard server in one of these Google Cloud Platform (GCP) regions because <a href=https://cloud.google.com/free/docs/gcp-free-tier#free-tier>it’s free</a>:</p><ul><li>Oregon: us-west1</li><li>Iowa: us-central1</li><li>South Carolina: us-east1</li></ul><p>GCE free tier specification is good enough for our VPN server.</p><hr><h1 id=part-1-set-up-gcp-networking>Part 1: Set up GCP Networking</h1><h2 id=open-a-port-through-gcps-firewall>Open a port through GCP’s firewall</h2><ul><li>On GCP console, click the hamburger menu on the top-left corner, click <em><strong>&ldquo;Networks&rdquo; -> &ldquo;VPC Network&rdquo; -> &ldquo;Firewall&rdquo; -> &ldquo;Create Firewall&rdquo;</strong></em></li><li>Create a name for our firewall rule</li><li>in <em><strong>“Direction of traffic”</strong></em> choose <em><strong>“ingress”</strong></em></li><li>in <em><strong>“Targets”</strong></em> choose <em><strong>“All instances in the network”</strong></em></li><li>in <em><strong>“Source filter”</strong></em> choose <em><strong>“IP Ranges”</strong></em></li><li>in <strong>“IP Range”</strong> fill <em><strong>“0.0.0.0/0”</strong></em> (allow all traffic)</li><li>in <em><strong>“Protocols and ports”</strong></em> click <em><strong>“Specified protocol and ports”</strong></em></li><li>Tick <em><strong>“udp”</strong></em>, enter port number <em><strong>“51820”</strong></em></li><li>click <em><strong>“Create”</strong></em></li></ul><h2 id=create-external-static-ip-address-for-vm>Create external static IP address for VM</h2><ul><li>in <em><strong>Networks menu</strong></em>, click <em><strong>&ldquo;VPC Network&rdquo; -> &ldquo;External IP Address&rdquo; -> &ldquo;Reserve Static Address&rdquo;</strong></em></li><li>Create a name for IP address</li><li>in <em><strong>“Network Service Tier”</strong></em> choose <em><strong>“Premium”</strong></em></li><li>in <em><strong>“IP version”</strong></em> select <em><strong>IPv4</strong></em></li><li>in <em><strong>“Type”</strong></em> select <em><strong>“Regional”</strong></em></li><li>Select your preferred GCP Region where you want to run the VPN server in</li><li>click <em><strong>“Reserve”</strong></em>.</li></ul><hr><h1 id=part-2-set-up-gce-vm-instance>Part 2: Set up GCE VM instance</h1><ul><li>in the top-left hamburger menu click <em><strong>&ldquo;Compute Engine&rdquo; -> &ldquo;VM Instances&rdquo; -> “Create Instance”</strong></em></li><li>Choose <em><strong>“New VM Instance”</strong></em> option in the left sidebar</li><li>Create a name for our VM (we’ll use: <em>wireguard</em>)</li><li>Choose your preferred Region to run VPN server in, the Zone does not matter</li><li>in <em><strong>“Machine family”</strong></em>, choose <em><strong>General Purpose</strong></em></li><li>in <em><strong>“Series”</strong></em>, choose <em><strong>E2</strong></em></li><li>in <em><strong>“Machine type”</strong></em>, choose <em><strong>“e2-micro"</strong></em></li><li>in <em><strong>“Boot disk”</strong></em>, choose <em><strong>“public image”</strong></em></li><li>under <em><strong>“Operating system”</strong></em>, choose <em><strong>“Ubuntu”</strong></em></li><li>under <em><strong>“version”</strong></em> choose <em><strong>“20.04 LTS”</strong></em></li><li>click <em><strong>“Management, security, disks, networking, sole tenancy”</strong></em></li><li>click <em><strong>Networking tab -> default network interface</strong></em></li><li>in <em><strong>External IP</strong></em>, select the IP address you’ve created in Part 1</li><li>check <em><strong>IP forwarding</strong></em></li><li>click <em><strong>Create</strong></em>.</li></ul><hr><h1 id=set-up-wireguard-server>Set up WireGuard Server</h1><ul><li><p>After you’ve created a new VM instance, you should be navigated back to list of GCE instances page. Wait for the status of your newly created VM instance to turn green.</p></li><li><p>Under <em><strong>“Connect”</strong></em> column, click <em><strong>“SSH”</strong></em>. A new browser window with a SSH terminal should appear.</p><p>The following steps are going to be done in the SSH terminal.</p></li><li><p>Update packages, enter <strong>Y</strong> if prompted:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt update <span style=color:#f92672>&amp;&amp;</span> sudo apt upgrade
</code></pre></div></li><li><p>Check whether your machine needs, a reboot:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat /var/run/reboot-required
</code></pre></div><p>if it returns <em><strong>&ldquo;System restart required&rdquo;</strong></em>, reboot your machine:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo reboot
</code></pre></div></li><li><p>Turn on IP forwarding for IPv4. edit <code>/etc/sysctl.conf</code> file, uncomment line <code>net.ipv4.ip_forward=1</code>, then apply the changes:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo sysctl -p
</code></pre></div></li><li><p>Install WireGuard, enter <strong>Y</strong> if prompted:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt install wireguard
</code></pre></div></li><li><p>Generate server keys with this chained commands:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo mkdir -p /etc/wireguard/keys; wg genkey | sudo tee /etc/wireguard/keys/server.key | wg pubkey | sudo tee /- etc/wireguard/keys/server.key.pub
</code></pre></div><p>That command will create a new directory <code>/etc/wireguard/keys</code>, generate and save server’s private key in <code>server.key</code>, and generate and save server’s public key in <code>server.key.pub</code>. We’re going to need those keys further along in the setup.</p><p>Use this command to see your server’s private key:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat /etc/wireguard/keys/server.key
</code></pre></div><p><strong>DO NOT SHOW YOUR SERVER&rsquo;S PRIVATE KEY TO ANYONE!</strong></p></li><li><p>Check your default network interface:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ip -o -4 route show to default | awk <span style=color:#e6db74>&#39;{print $5}&#39;</span>
</code></pre></div><p>take note of the command result.</p></li><li><p>Configure WireGuard interface. Create a new file <code>/etc/wireguard/wg0.conf</code>. Fill it with this below. Replace - <strong>&lt;YOUR_NETWORK_INTERFACE></strong> with your server’s network interface, and <strong>&lt;YOUR_SERVER_PRIVATE_KEY></strong> with your server&rsquo;s private key.</p><pre><code>[Interface]
Address = 10.0.0.1/24
ListenPort = 51820
PrivateKey = &lt;YOUR_SERVER_PRIVATE_KEY&gt;
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o &lt;YOUR_NETWORK_INTERFACE&gt; -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o &lt;YOUR_NETWORK_INTERFACE&gt; -j MASQUERADE
SaveConfig = true
</code></pre></li><li><p>Set permission for <code>wg0.conf</code>, <code>server.key</code>, and <code>server.key.pub</code> to be accessible only by root:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo chmod <span style=color:#ae81ff>600</span> /etc/wireguard/wg0.conf
sudo chmod <span style=color:#ae81ff>600</span> /etc/wireguard/keys/server.key
sudo chmod <span style=color:#ae81ff>600</span> /etc/wireguard/keys/server.key.pub
</code></pre></div></li><li><p>Turn on WireGuard interface <code>wg0</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo wg-quick up wg0
</code></pre></div><p>make sure <code>wg0</code> has run, and it’s public key is equal to content of <code>server.key.pub</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo wg show wg0
</code></pre></div></li><li><p>Set wg0 to start at boot:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo systemctl enable wg-quick@wg0
</code></pre></div></li><li><p>Open WireGuard port through firewall:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo ufw allow 51820/udp
</code></pre></div><p>Open port for SSH as well:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo ufw allow 22/tcp
</code></pre></div></li><li><p>Turn on firewall:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo ufw enable
</code></pre></div></li><li><p>Check firewall status, make sure the port for WireGuard and SSH are opened:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo ufw status verbose
</code></pre></div></li><li><p>Set MTU size to 1360 due to <a href=https://cloud.google.com/network-connectivity/docs/vpn/concepts/mtu-considerations#gateway_mtu_vs_system_mtu>limitation in GCP</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo ip link set dev wg0 mtu <span style=color:#ae81ff>1360</span>
</code></pre></div></li></ul><hr><h1 id=part-4-set-up-wireguard-client>Part 4: Set Up WireGuard Client</h1><p>We’re going to setup WireGuard client on Android by generating a QR code to be scanned by the client app.</p><ul><li><p>On the server, install <code>qrencode</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt install qrencode
</code></pre></div></li><li><p>Run this chained commands:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo mkdir -p /etc/wireguard/clients; wg genkey | sudo tee /etc/wireguard/clients/mobile.key | wg pubkey | sudo tee /etc/wireguard/clients/mobile.key.pub
</code></pre></div><p>That command will create a new directory <code>/etc/wireguard/clients</code>, generate and save our client’s private key in <code>mobile.key</code>, and finally generate and save our client’s public key in <code>mobile.key.pub</code>.</p></li><li><p>Create an interface for your WireGuard client. Create a new file <code>/etc/wireguard/mobile.conf</code>, fill with this below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>Interface<span style=color:#f92672>]</span>
PrivateKey <span style=color:#f92672>=</span> &lt;PRIVATE-KEY-OF-CLIENT&gt;
Address <span style=color:#f92672>=</span> &lt;PRIVATE-IP-OF-WIREGUARD-SERVER&gt;/24
DNS <span style=color:#f92672>=</span> 1.1.1.1, 1.0.0.1
MTU <span style=color:#f92672>=</span> <span style=color:#ae81ff>1360</span>

<span style=color:#f92672>[</span>Peer<span style=color:#f92672>]</span>
PublicKey <span style=color:#f92672>=</span> &lt;PUBLIC-KEY-OF-YOUR-SERVER&gt;
AllowedIPs <span style=color:#f92672>=</span> 0.0.0.0/0
Endpoint <span style=color:#f92672>=</span> &lt;STATIC-IP-OF-GCP-INSTANCE&gt;:51820
</code></pre></div><p>Replace the placeholders:</p><ul><li>Replace <em>PRIVATE-KEY-OF-CLIENT</em> with content of <code>mobile.key</code>.</li><li>Replace <em>PRIVATE-IP-OF-WIREGUARD-SERVER</em> to <em>10.0.0.1/24</em>.</li><li>Replace <em>PUBLIC-KEY-OF-YOUR-SERVER</em> with your server’s public key (check out <code>server.key.pub</code> or run <code>sudo wg show wg0</code>).</li><li>Replace <em>STATIC-IP-OF-GCP-INSTANCE</em> with IP address you’ve created in Part 1.</li></ul></li><li><p>Download the <a href="https://play.google.com/store/apps/details?id=com.wireguard.android">official WireGuard Android app</a> in your phone.</p></li><li><p>Add client to server’s interface. Run this command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo wg set wg0 peer &lt;YOUR_CLIENT_PUBLIC_KEY&gt; allowed-ips &lt;YOUR_CLIENT_VPN_IP&gt;
</code></pre></div><p>Replace <em>YOUR_CLIENT_VPN_IP</em> to <em>10.0.0.2/32</em>, and replace <em>YOUR_CLIENT_PUBLIC_KEY</em> with content of <code>mobile.key.pub</code>,</p><p>Make sure your client already added to server:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  sudo wg show wg0
</code></pre></div></li><li><p>Make <code>/etc/wireguard/</code> accessible <em>TEMPORARILY</em>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo chmod <span style=color:#ae81ff>777</span> /etc/wireguard/
sudo chmod <span style=color:#ae81ff>777</span> /etc/wireguard/clients/
sudo chmod <span style=color:#ae81ff>777</span> /etc/wireguard/clients/mobile.conf
</code></pre></div></li><li><p>Generate QR code to transfer client’s interface config to your phone:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qrencode -t ansiutf8 &lt; /etc/wireguard/clients/mobile.conf
</code></pre></div></li><li><p>Make <code>/etc/wireguard/</code> accessible to only root again:<br><strong>DO NOT FORGET TO DO THIS!</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo chmod <span style=color:#ae81ff>600</span> /etc/wireguard/
sudo chmod <span style=color:#ae81ff>600</span> /etc/wireguard/clients/
sudo chmod <span style=color:#ae81ff>600</span> /etc/wireguard/clients/mobile.conf
</code></pre></div></li><li><p>Open WireGuard app on your phone, tap the floating <strong>+</strong> button on the bottom-right corner, and choose <em><strong>SCAN FROM QR CODE</strong></em>.</p></li><li><p>Scan the generated QR code, and give the tunnel a name.</p></li><li><p>Connect to the tunnel, and check your ip (search this keyword on Google: “whatsmyip”). Your IP should be equal to the external IP you’ve created in Part 1.</p></li></ul><p>You can find how to connect more types of client (e.g. Windows PC, MacOS, iOS) in Reference no. 3.</p><hr><h1 id=references>References</h1><ol><li><a href=https://cloud.google.com/free/docs/gcp-free-tier#free-tier>GCP free tier.</a></li><li><a href=https://wireguard.how/server/google-cloud-platform/>Jacob Marble’s WireGuard server setup guide on GCP.</a></li><li><a href=https://serversideup.net/courses/gain-flexibility-and-increase-privacy-with-wireguard-vpn/>Jay Rogers’ WireGuard setup course in ServerSideUp.</a></li><li><a href=https://github.com/StreisandEffect/streisand/issues/1552#issuecomment-479996371.>howyay’s MTU solution in Github.</a></li><li><a href=https://cloud.google.com/network-connectivity/docs/vpn/concepts/mtu-considerations#gateway_mtu_vs_system_mtu>Limitations of MTU in Google Cloud Platform.</a></li></ol></article></main><footer id=footer></footer></body></html>